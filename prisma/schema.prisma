generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int           @id @default(autoincrement())
  name          String
  email         String        @unique
  password      String
  role          String
  referralCode  String
  pointsBalance Int
  createdAt     DateTime      @default(now())
  events        Event[]
  reviews       Review[]
  transactions  Transaction[]
  vouchers      Voucher[]
  attendees     Attendee[]

  @@map("users")
}

model Event {
  id             Int           @id @default(autoincrement())
  organizerId    Int
  organizer      User          @relation(fields: [organizerId], references: [id])
  title          String        @unique
  description    String
  categoryId     Int
  category       Category      @relation(fields: [categoryId], references: [id])
  location       String
  price          Int
  startAt        DateTime
  endAt          DateTime
  totalSeats     Int
  availableSeats Int
  isFree         Boolean
  image          String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  tickets        Ticket[]
  reviews        Review[]
  transactions   Transaction[]
  vouchers       Voucher[]
  attendees      Attendee[]

  @@map("events")
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String
  events Event[]

  @@map("categories")
}

model Ticket {
  id                Int           @id @default(autoincrement())
  eventId           Int
  event             Event         @relation(fields: [eventId], references: [id])
  name              String
  price             Int
  quantityAvailable Int
  transactions      Transaction[]
  attendees         Attendee[]

  @@map("tickets")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id])
  rating    Int
  comment   String
  createdAt DateTime @default(now())

  @@map("reviews")
}

model Transaction {
  id              Int        @id @default(autoincrement())
  userId          Int
  user            User       @relation(fields: [userId], references: [id])
  eventId         Int
  event           Event      @relation(fields: [eventId], references: [id])
  ticketId        Int
  ticket          Ticket     @relation(fields: [ticketId], references: [id])
  voucherId       Int
  voucher         Voucher    @relation(fields: [voucherId], references: [id])
  quantity        Int
  totalPrice      Int
  status          Status     @default(WAITING_FOR_PAYMENT)
  paymentProofUrl String
  expiresAt       DateTime
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  pointsUsed      Int
  attendees       Attendee[]

  @@map("transactions")
}

model Voucher {
  id             Int           @id @default(autoincrement())
  organizerId    Int
  organizer      User          @relation(fields: [organizerId], references: [id])
  eventId        Int
  event          Event         @relation(fields: [eventId], references: [id])
  code           String
  discountAmount Int
  startAt        DateTime
  endAt          DateTime
  usageLimit     Int
  usedCount      Int
  transactions   Transaction[]

  @@map("vouchers")
}

model Attendee {
  id            Int         @id @default(autoincrement())
  ticketCode    String      @unique
  isCheckedIn   Boolean     @default(false)
  checkedInAt   DateTime?
  eventId       Int
  event         Event       @relation(fields: [eventId], references: [id])
  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  ticketId      Int
  ticket        Ticket      @relation(fields: [ticketId], references: [id])

  createdAt DateTime @default(now())

  @@map("attendees")
}

enum Status {
  WAITING_FOR_PAYMENT
  WAITING_FOR_ADMIN_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}
