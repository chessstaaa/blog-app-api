generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int           @id @default(autoincrement())
  name          String
  email         String        @unique
  password      String
  role          String
  referralCode  String
  pointsBalance Int
  createdAt     DateTime      @default(now())
  events        Event[]
  reviews       Review[]
  transactions  Transaction[]
  vouchers      Voucher[]

  @@map("users")
}

model Event {
  id             Int           @id @default(autoincrement())
  slug           String        @unique
  organizerId    Int
  organizer      User          @relation(fields: [organizerId], references: [id])
  title          String        @unique
  description    String
  categoryId     Int
  category       Category      @relation(fields: [categoryId], references: [id])
  location       String
  price          Int
  startAt        DateTime
  endAt          DateTime
  totalSeats     Int
  availableSeats Int
  isFree         Boolean
  image          String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  tickets        Ticket[]
  reviews        Review[]
  transactions   Transaction[]
  vouchers       Voucher[]

  @@map("events")
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String
  events Event[]

  @@map("categories")
}

model Ticket {
  id                Int      @id @default(autoincrement())
  eventId           Int
  event             Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name              String
  price             Int
  quantityAvailable Int
  transactions      Transaction[]
  transactionItems  TransactionItem[]

  @@map("tickets")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  rating    Int
  comment   String
  createdAt DateTime @default(now())

  @@map("reviews")
}

model Transaction {
  id              Int               @id @default(autoincrement())
  userId          Int
  user            User              @relation(fields: [userId], references: [id])

  eventId         Int
  event           Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // LEGACY (tidak dihapus agar sistem lama aman)
  ticketId        Int?
  ticket          Ticket?           @relation(fields: [ticketId], references: [id])

  voucherId       Int?
  voucher         Voucher?          @relation(fields: [voucherId], references: [id])

  // TOTAL FINAL SETELAH VOUCHER + POINT
  price           Int
  pointsUsed      Int               @default(0)

  status          TransactionStatus @default(WAITING_FOR_PAYMENT)
  paymentProofUrl String?
  expiresAt       DateTime
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // ðŸ”¥ MULTI TICKET ORDER (INI YANG BARU)
  items           TransactionItem[]

  @@map("transactions")
}

model TransactionItem {
  id            Int          @id @default(autoincrement())

  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  name     String
  price    Int
  qty      Int
  subtotal Int

  @@map("transaction_items")
}


enum TransactionStatus {
  WAITING_FOR_PAYMENT
  WAITING_FOR_ADMIN_CONFIRMATION
  PAID
  REJECTED
  EXPIRED
  CANCELED
}

model Voucher {
  id             Int      @id @default(autoincrement())
  organizerId    Int
  organizer      User     @relation(fields: [organizerId], references: [id])
  eventId        Int
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  code           String
  discountAmount Int
  startAt        DateTime
  endAt          DateTime
  usageLimit     Int
  usedCount      Int
  transactions   Transaction[]

  @@map("vouchers")
}